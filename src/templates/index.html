{% extends "layout.html" %} {% block body %}

<div class="d-flex flex-column justify-content-center">
  <div class="d-flex justify-content-center">
    <img src="static/img/banner.png" alt="Banner" style="max-width: 60%; border-radius:20px"/>
  </div>
  <div class="card card-body p-5 mt-5" style="border-radius: 20px;">
    {% with nueva_url = get_flashed_messages() %}

    <form id="url-form">
      <div class="input-group mb-3 mt-3">
        <span class="input-group-text" id="bassic-addon3" style="border-radius:10px;">Ingresa URL</span>
        <input type="url" class="form-control ms-2" style="border-radius: 10px;" id="url-input" name="url" placeholder="https://ejemplo.com" required/>
        <button type="submit" class ="btn btn-primary ms-2" style="border-radius: 10px;">Cortar URL</button>
      </div>
    </form>
    
    <!-- Área para mostrar el resultado -->
    <div id="result-area" class="input-group mb-3" style="display: none;">
      <input id="nueva-url" type="text" class="form-control ms-2 mt-2" style="border-radius: 10px;" readonly/>
      <button id="btn-copiar" onclick="copiarURL()" type="button" class="btn btn-outline-success ms-2 mt-2" style="border-radius: 10px;">Copiar URL</button>
    </div>
    
    <!-- Área para mostrar errores -->
    <div id="error-area" class="alert alert-danger mt-3" style="display: none; border-radius: 10px;"></div>
    {% endwith %}
  </div>
</div>
<script>
  // Limpiar el input al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    const nuevaUrlInput = document.getElementById('nueva-url');
    const resultArea = document.getElementById('result-area');
    
    // Asegurar que el área de resultado esté oculta al cargar
    resultArea.style.display = 'none';
    nuevaUrlInput.value = '';
    console.log('Página cargada - input limpiado');
  });

  // Manejar el submit del formulario con AJAX
  document.getElementById('url-form').addEventListener('submit', async function(e) {
    e.preventDefault(); // Prevenir el submit tradicional
    
    const urlInput = document.getElementById('url-input');
    const resultArea = document.getElementById('result-area');
    const errorArea = document.getElementById('error-area');
    const nuevaUrlInput = document.getElementById('nueva-url');
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    // Ocultar áreas de resultado y error
    resultArea.style.display = 'none';
    errorArea.style.display = 'none';
    
    // Mostrar estado de carga
    submitButton.disabled = true;
    submitButton.innerHTML = 'Procesando...';
    
    // Crear FormData para enviar al servidor
    const formData = new FormData();
    formData.append('url', urlInput.value);
    console.log('Enviando URL:', urlInput.value); // Debug
    
    try {
      // Enviar petición al servidor
      const response = await fetch('/create', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      console.log('Respuesta del servidor:', data); // Debug
      
      if (data.short_link) {
        // Mostrar el resultado exitoso
        console.log('Short link recibido:', data.short_link); // Debug
        
        // Asignar valor al input de múltiples maneras para asegurar que funcione
        nuevaUrlInput.value = data.short_link;
        nuevaUrlInput.setAttribute('value', data.short_link);
        
        console.log('Valor asignado al input:', nuevaUrlInput.value); // Debug
        console.log('Atributo value del input:', nuevaUrlInput.getAttribute('value')); // Debug
        
        // Mostrar el área de resultado
        resultArea.style.display = 'block';
        
        // Forzar un re-render
        setTimeout(() => {
          console.log('Verificación final - valor del input:', nuevaUrlInput.value);
        }, 100);
        
        urlInput.value = ''; // Limpiar el formulario
      } else if (data.error) {
        // Mostrar error
        console.log('Error del servidor:', data.error); // Debug
        errorArea.textContent = data.error;
        errorArea.style.display = 'block';
      } else {
        // Si no hay short_link ni error, mostrar la respuesta completa
        console.log('Respuesta inesperada:', data);
        errorArea.textContent = 'Respuesta inesperada del servidor: ' + JSON.stringify(data);
        errorArea.style.display = 'block';
      }
    } catch (error) {
      // Mostrar error de conexión
      console.log('Error de conexión:', error); // Debug
      errorArea.textContent = 'Error de conexión: ' + error.message;
      errorArea.style.display = 'block';
    } finally {
      // Restaurar el botón
      submitButton.disabled = false;
      submitButton.innerHTML = 'Cortar URL';
    }
  });

  function copiarURL() {
    const nuevaURL = document.getElementById("nueva-url");
    nuevaURL.select();
    nuevaURL.setSelectionRange(0, 99999); // Para dispositivos móviles
    
    // Usar la API moderna de clipboard si está disponible
    if (navigator.clipboard) {
      navigator.clipboard.writeText(nuevaURL.value);
    } else {
      // Fallback para navegadores más antiguos
      document.execCommand("copy");
    }

    const btnCopiar = document.getElementById("btn-copiar");
    btnCopiar.innerHTML = "¡Copiado!";
    btnCopiar.classList.replace("btn-outline-success", "btn-success");

    setTimeout(() => {
      // Resetear el botón y ocultar el resultado
      btnCopiar.innerHTML = "Copiar URL";
      btnCopiar.classList.replace("btn-success", "btn-outline-success");
      document.getElementById('result-area').style.display = 'none';
    }, 3000);
  }
</script>

{% endblock %}